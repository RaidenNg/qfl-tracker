<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BankRoll Buddy</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap');

        :root {
            /* Light Theme Colors */
            --light-bg: #f8fafc;
            --light-surface: #ffffff;
            --light-text: #1e293b;
            --light-text-secondary: #64748b;
            --light-border: #e2e8f0;
            --light-hover: #f1f5f9;

            /* Dark Theme Colors */
            --dark-bg: #0f172a;
            --dark-surface: #1e293b;
            --dark-text: #f8fafc;
            --dark-text-secondary: #94a3b8;
            --dark-border: #334155;
            --dark-hover: #2d3748;

            /* Default to light theme */
            --bg: var(--light-bg);
            --surface: var(--light-surface);
            --text: var(--light-text);
            --text-secondary: var(--light-text-secondary);
            --border: var(--light-border);
            --hover: var(--light-hover);

            /* Font sizes */
            --font-xs: 0.875rem;    /* 14px */
            --font-sm: 1rem;        /* 16px */
            --font-md: 1.125rem;    /* 18px */
            --font-lg: 1.25rem;     /* 20px */
            --font-xl: 1.5rem;      /* 24px */
            --font-2xl: 2rem;       /* 32px */
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: var(--font-md);
            line-height: 1.6;
            background: var(--bg);
            color: var(--text);
        }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            padding-top: 140px; /* Adjust based on your header height */
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            padding: 15px;
            z-index: 100;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding-bottom: 80px; /* Space for mobile nav */
        }

        /* Panels */
        .left-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .right-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Sections */
        .section-title {
            font-family: 'Poppins', sans-serif;
            font-size: var(--font-xl);
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: var(--text);
        }

        .wallets-section,
        .cashout-section,
        .stats-section,
        .risk-section {
            margin-bottom: 30px;
        }

        /* Wallets */
        .wallet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .wallet-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .wallet-name {
            font-family: 'Poppins', sans-serif;
            font-size: var(--font-md);
            font-weight: 500;
        }

        .wallet-amount {
            font-size: var(--font-lg);
            font-weight: 600;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
            margin-bottom: 15px;
        }

        .record-form {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .record-form h3 {
            margin-bottom: 15px;
            color: #0f172a;
        }

        .form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        input, select {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.95em;
        }

        /* Buttons */
        .btn {
            font-family: 'Poppins', sans-serif;
            font-size: var(--font-sm);
            font-weight: 500;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.9em;
        }

        .full-width {
            width: 100%;
        }

        /* Tables */
        .records-table {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            font-family: 'Poppins', sans-serif;
            font-size: var(--font-sm);
            font-weight: 600;
            text-align: left;
            padding: 12px;
            background: #f8fafc;
        }

        td {
            font-size: var(--font-md);
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        /* Stats and Alerts */
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: var(--font-md);
        }

        .stat-item span:first-child {
            font-weight: 500;
        }

        .risk-alert {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: var(--font-md);
            line-height: 1.8;
            color: var(--text); /* This will use theme text color */
        }

        .risk-alert strong {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .risk-controls {
            margin-bottom: 15px;
        }

        .risk-control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .risk-control-item label {
            font-weight: 500;
        }

        .risk-control-item input {
            width: 80px;
        }

        /* Utility Classes */
        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .close {
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            color: #666;
        }

        .close:hover {
            color: #000;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Footer */
        .app-footer {
            text-align: center;
            margin-top: 40px;
            padding: 30px 20px;
            background: linear-gradient(to bottom, transparent, rgba(226, 232, 240, 0.3));
            border-top: 1px solid rgba(226, 232, 240, 0.5);
        }

        .copyright {
            font-size: var(--font-sm);
            color: #64748b;
            margin-bottom: 20px;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .code-snippet {
            display: inline-block;
            text-align: left;
            background: #1e1e1e; /* VS Code dark theme background */
            color: #d4d4d4; /* VS Code default text color */
            padding: 20px 25px;
            border-radius: 8px;
            font-family: 'Consolas', 'JetBrains Mono', monospace;
            font-size: var(--font-sm);
            line-height: 1.5;
            margin: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Syntax highlighting for VS Code-like appearance */
        .code-keyword {
            color: #569cd6; /* blue for keywords */
        }

        .code-function {
            color: #dcdcaa; /* yellow for functions */
        }

        .code-operator {
            color: #d4d4d4; /* white for operators */
        }

        .code-comment {
            color: #6a9955; /* green for comments */
        }

        /* New Styles */
        .start-amount-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .start-amount-group input {
            flex: 1;
        }

        .start-amount-group .btn-small {
            padding: 8px 12px;
            white-space: nowrap;
        }

        .data-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .data-controls .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .data-controls input[type="file"] {
            display: none;
        }

        /* Level Up Section Styles */
        .level-section {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .level-controls {
            margin-bottom: 15px;
        }

        .level-display {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 6px;
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-family: 'Poppins', sans-serif;
        }

        .level-number {
            font-size: var(--font-lg);
            font-weight: 600;
        }

        .progress-bar {
            height: 24px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            background: linear-gradient(to right, #4f46e5, #7c3aed);
        }

        /* Level color variations */
        .progress-fill.novice {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
        }

        .progress-fill.advanced {
            background: linear-gradient(to right, #059669, #10b981);
        }

        .progress-fill.expert {
            background: linear-gradient(to right, #d97706, #fbbf24);
        }

        .progress-fill.master {
            background: linear-gradient(to right, #dc2626, #ef4444);
        }

        .progress-fill.legend {
            background: linear-gradient(to right, #7e22ce, #d946ef);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .left-panel {
                order: 2;
            }
            
            .right-panel {
                order: 1;
            }
        }

        @media (max-width: 640px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* Mobile Optimization Styles */
        @media (max-width: 768px) {
            body {
                /* Remove default iOS tap highlight */
                -webkit-tap-highlight-color: transparent;
                /* Prevent elastic scrolling */
                overscroll-behavior: none;
            }

            .header {
                padding: 10px;
            }

            .container {
                padding-top: 120px; /* Slightly smaller for mobile */
            }

            .main-content {
                height: calc(100vh - 120px);
                overflow-y: auto;
                padding-bottom: 80px; /* Space for mobile nav */
            }

            .left-panel,
            .right-panel {
                border-radius: 16px;
                margin-bottom: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            /* Mobile Navigation */
            .mobile-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--surface);
                border-top: 1px solid var(--border);
                padding: 10px;
                justify-content: space-around;
                z-index: 100;
            }

            .nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                font-size: 12px;
                color: var(--text-secondary);
                text-decoration: none;
                padding: 8px;
            }

            .nav-item i {
                font-size: 20px;
                margin-bottom: 4px;
            }

            .nav-item.active {
                color: var(--primary);
            }

            /* Adjust form elements for touch */
            input, select, button {
                min-height: 44px; /* Apple's recommended minimum */
                font-size: 16px; /* Prevent iOS zoom */
            }

            .btn {
                padding: 12px 20px;
            }

            /* Mobile-friendly tables */
            .records-table {
                margin: 0 -10px;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            td, th {
                padding: 12px 15px;
            }

            /* Mobile modals */
            .modal-content {
                margin: 0;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: 20px 20px 0 0;
                max-width: none;
                animation: slideUp 0.3s ease-out;
            }

            @keyframes slideUp {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }

            /* Hide footer on mobile */
            .app-footer {
                display: none;
            }

            /* Add pull-to-refresh indicator */
            .ptr-element {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                color: var(--text-secondary);
                text-align: center;
                height: 50px;
            }
        }

        /* iOS-specific adjustments */
        @supports (-webkit-touch-callout: none) {
            .container {
                /* Prevent rubber-band scroll on iOS */
                position: fixed;
                width: 100%;
                height: 100%;
            }

            .header {
                position: sticky;
            }
        }

        /* Update the footer CSS */
        @media (max-width: 768px) {
            .app-footer {
                display: block; /* Show footer on mobile instead of hiding it */
                margin: 10px;
                padding: 15px;
                background: var(--surface);
                border-radius: 16px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                margin-bottom: 80px; /* Add space for mobile navigation */
            }

            .code-snippet {
                width: 100%;
                font-size: 12px;
                padding: 15px;
                margin: 10px 0;
                border-radius: 8px;
                overflow-x: auto;
            }

            .copyright {
                font-size: 12px;
                margin-bottom: 10px;
            }

            /* Ensure footer doesn't get hidden under mobile nav */
            .main-content {
                padding-bottom: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="theme-toggle">
                <button class="theme-btn" onclick="UI.toggleTheme()">
                    <i class="fas fa-moon dark-icon"></i>
                    <i class="fas fa-sun light-icon"></i>
                </button>
            </div>
            <h1>üéØ BankRoll Buddy</h1>
            <p>Your Smart Crypto Betting Companion</p>
            <div class="data-controls">
                <button class="btn btn-primary" onclick="DataManager.saveToFile()">
                    <i class="fas fa-download"></i> Save Data
                </button>
                <label class="btn btn-primary">
                    <i class="fas fa-upload"></i> Load Data
                    <input type="file" id="load-data" hidden accept=".json" 
                           onchange="DataManager.loadFromFile(this.files[0])">
                </label>
            </div>
        </header>

        <main class="main-content">
            <!-- Left Panel: Wallets & Stats -->
            <section class="left-panel">
                <!-- Wallets Section -->
                <div class="wallets-section">
                    <h2 class="section-title">üí∞ Crypto Wallets</h2>
                    <div id="wallets-container"></div>
                    <button class="btn btn-primary full-width" onclick="WalletManager.showAddModal()">
                        ‚ûï Add Wallet
                    </button>
                </div>

                <!-- Cash Out Section -->
                <div class="cashout-section">
                    <div class="stat-item">
                        <span>Total Withdrawn:</span>
                        <span id="total-cashout" class="positive">$0.00</span>
                    </div>
                    <button class="btn btn-success full-width" onclick="CashoutManager.showModal()">
                        üí∏ Cash Out
                    </button>
                </div>

                <!-- Statistics Section -->
                <div class="stats-section">
                    <h2 class="section-title">üìä Statistics</h2>
                    <div id="stats-container"></div>
                </div>

                <!-- Risk Management Section - Moved above Level Up -->
                <div class="risk-section">
                    <h2 class="section-title">‚ö†Ô∏è Risk Management</h2>
                    <div id="risk-controls" class="risk-controls">
                        <div class="risk-control-item">
                            <label>Position Size (%):</label>
                            <input type="number" id="position-size" value="1" min="0.1" max="10" step="0.1" onchange="SettingsManager.updatePositionSize()">
                        </div>
                        <div class="risk-control-item">
                            <label>Stop Loss (%):</label>
                            <input type="number" id="stop-loss" value="10" min="1" max="50" step="1" onchange="SettingsManager.updateStopLoss()">
                        </div>
                    </div>
                    <div id="risk-alerts"></div>
                </div>

                <!-- Add Currency Converter Section -->
                <div class="converter-section">
                    <h2 class="section-title">üí± Currency Converter</h2>
                    <div class="converter-controls">
                        <div class="converter-input">
                            <label>AUD Amount:</label>
                            <input type="number" id="aud-amount" placeholder="Enter AUD" step="0.01" 
                                   onchange="UI.convertCurrency('aud')">
                        </div>
                        <div class="converter-input">
                            <label>USD Amount:</label>
                            <input type="number" id="usd-amount" placeholder="Enter USD" step="0.01"
                                   onchange="UI.convertCurrency('usd')">
                        </div>
                        <div class="rate-info">
                            Current Rate: 1 AUD = <span id="exchange-rate">0.65</span> USD
                        </div>
                    </div>
                </div>

                <!-- Level Up Section - Now after Risk Management -->
                <div class="level-section">
                    <h2 class="section-title">‚öîÔ∏è LEVEL UP</h2>
                    <div class="level-controls">
                        <select id="level-difficulty" class="select-custom" onchange="UI.updateLevelProgress()">
                            <option value="100">Easy ($100/level)</option>
                            <option value="250">Medium ($250/level)</option>
                            <option value="500">Hard ($500/level)</option>
                            <option value="1000">Expert ($1000/level)</option>
                        </select>
                    </div>
                    <div class="level-display">
                        <div class="level-info">
                            <span class="level-number">Level <span id="current-level">0</span></span>
                            <span class="level-progress" id="level-progress-text">0/100</span>
                        </div>
                        <div class="progress-bar">
                            <div id="level-progress-bar" class="progress-fill"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Right Panel: Records -->
            <section class="right-panel">
                <h2 class="section-title">üìÖ Daily Records</h2>
                
                <!-- New Record Form -->
                <div class="record-form">
                    <h3>Add New Record</h3>
                    <div class="form-grid">
                        <select id="record-wallet" onchange="RecordManager.updateStartAmount()">
                            <option value="">Select Wallet</option>
                        </select>
                        <input type="date" id="record-date">
                        <div class="start-amount-group">
                            <input type="number" id="record-start" placeholder="Start Amount" step="0.01">
                            <button class="btn btn-primary btn-small" onclick="RecordManager.useFullAmount()">Use All</button>
                        </div>
                        <input type="number" id="record-end" placeholder="End Amount" step="0.01" 
                               oninput="RecordManager.calculateProfit()">
                    </div>
                    <input type="text" id="record-note" placeholder="Notes (optional)" class="full-width">
                    <div class="form-footer">
                        <span id="profit-preview"></span>
                        <button class="btn btn-success" onclick="RecordManager.add()">Add Record</button>
                    </div>
                </div>

                <!-- Records Table -->
                <div class="records-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>P/L</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="records-tbody"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="copyright">¬© 2025 Created with üíú by Raiden Z</div>
            <pre class="code-snippet">
<span class="code-keyword">while</span> (<span class="code-function">alive</span>) {
    <span class="code-function">eat</span>();
    <span class="code-function">sleep</span>();
    <span class="code-function">code</span>();
    <span class="code-keyword">if</span> (profit > goal) {
        <span class="code-function">celebrate</span>();
        goal <span class="code-operator">*=</span> 2;
    }
}
<span class="code-comment">// Life is a loop, keep grinding! üöÄ</span></pre>
        </footer>
    </div>

    <!-- Wallet Modal -->
    <div id="wallet-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Wallet</h3>
                <span class="close" onclick="WalletManager.closeModal()">&times;</span>
            </div>
            <div class="modal-form">
                <input type="text" id="wallet-name" placeholder="Wallet Name" required>
                <input type="number" id="wallet-amount" placeholder="Initial Amount" step="0.01" required>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="WalletManager.closeModal()">Cancel</button>
                    <button class="btn btn-success" onclick="WalletManager.addWallet()">Add Wallet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cashout Modal -->
    <div id="cashout-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cash Out</h3>
                <span class="close" onclick="CashoutManager.closeModal()">&times;</span>
            </div>
            <div class="modal-form">
                <select id="cashout-wallet" required>
                    <option value="">Select Wallet</option>
                </select>
                <input type="number" id="cashout-amount" placeholder="Amount to withdraw" step="0.01" required>
                <input type="text" id="cashout-note" placeholder="Notes (optional)">
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="CashoutManager.closeModal()">Cancel</button>
                    <button class="btn btn-success" onclick="CashoutManager.processCashout()">Cash Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav" id="mobile-nav">
        <a href="#wallets" class="nav-item active" onclick="UI.showSection('wallets')">
            <i class="fas fa-wallet"></i>
            <span>Wallets</span>
        </a>
        <a href="#records" class="nav-item" onclick="UI.showSection('records')">
            <i class="fas fa-history"></i>
            <span>Records</span>
        </a>
        <a href="#stats" class="nav-item" onclick="UI.showSection('stats')">
            <i class="fas fa-chart-bar"></i>
            <span>Stats</span>
        </a>
        <a href="#settings" class="nav-item" onclick="UI.showSection('settings')">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </a>
    </nav>

    <script>
        // State Management
        const AppState = {
            wallets: [],
            records: [],
            cashouts: [],
            settings: {
                positionSize: 1,
                stopLoss: 10
            }
        };

        // Update the DataManager object with improved persistence
        const DataManager = {
            saveToFile() {
                try {
                    const data = {
                        wallets: AppState.wallets,
                        records: AppState.records,
                        cashouts: AppState.cashouts,
                        settings: AppState.settings,
                        exportDate: new Date().toISOString(),
                        version: '1.0'
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bankroll-backup-${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert('Data saved successfully!');
                } catch (error) {
                    alert('Error saving data: ' + error.message);
                    console.error('Save error:', error);
                }
            },

            loadFromFile(file) {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validate data structure
                        if (!data.wallets || !data.records || !data.settings) {
                            throw new Error('Invalid backup file format');
                        }

                        if (!confirm('This will replace all current data. Continue?')) {
                            return;
                        }

                        // Update AppState
                        AppState.wallets = data.wallets;
                        AppState.records = data.records;
                        AppState.cashouts = data.cashouts || [];
                        AppState.settings = {...AppState.settings, ...data.settings};

                        // Save to localStorage for persistence
                        this.saveToLocalStorage();

                        // Update UI
                        UI.update();
                        
                        // Update settings inputs
                        document.getElementById('position-size').value = AppState.settings.positionSize;
                        document.getElementById('stop-loss').value = AppState.settings.stopLoss;

                        alert('Data loaded successfully!');
                    } catch (error) {
                        alert('Error loading data: ' + error.message);
                        console.error('Load error:', error);
                    }
                };
                reader.readAsText(file);
            },

            // Add these new methods
            saveToLocalStorage() {
                try {
                    localStorage.setItem('bankrollData', JSON.stringify({
                        wallets: AppState.wallets,
                        records: AppState.records,
                        cashouts: AppState.cashouts,
                        settings: AppState.settings,
                        lastUpdated: new Date().toISOString()
                    }));
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                }
            },

            loadFromLocalStorage() {
                try {
                    const savedData = localStorage.getItem('bankrollData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        if (this.validateData(data)) {
                            AppState.wallets = data.wallets;
                            AppState.records = data.records;
                            AppState.cashouts = data.cashouts || [];
                            AppState.settings = {...AppState.settings, ...data.settings};
                            return true;
                        }
                    }
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                }
                return false;
            },

            validateData(data) {
                // Add validation rules as needed
                if (!Array.isArray(data.wallets)) throw new Error('Invalid wallets data');
                if (!Array.isArray(data.records)) throw new Error('Invalid records data');
                if (!data.settings) throw new Error('Invalid settings data');
                
                // Validate each wallet has required properties
                data.wallets.forEach(wallet => {
                    if (!wallet.id || !wallet.name || typeof wallet.amount !== 'number') {
                        throw new Error('Invalid wallet data structure');
                    }
                });

                // Validate each record has required properties
                data.records.forEach(record => {
                    if (!record.id || !record.date || 
                        typeof record.start !== 'number' || 
                        typeof record.end !== 'number') {
                        throw new Error('Invalid record data structure');
                    }
                });

                return true;
            }
        };

        // Wallet Management
        const WalletManager = {
            showAddModal() {
                document.getElementById('wallet-modal').style.display = 'block';
                document.getElementById('wallet-name').focus();
            },

            closeModal() {
                document.getElementById('wallet-modal').style.display = 'none';
                document.getElementById('wallet-name').value = '';
                document.getElementById('wallet-amount').value = '';
            },

            addWallet() {
                const name = document.getElementById('wallet-name').value.trim();
                const amount = parseFloat(document.getElementById('wallet-amount').value);

                if (!name || isNaN(amount)) {
                    alert('Please enter valid wallet details');
                    return;
                }
                
                AppState.wallets.push({
                    id: Date.now(),
                    name: name,
                    amount: amount
                });
                
                this.closeModal();
                UI.update();
            },

            delete(id) {
                if (!confirm('Delete this wallet? All associated records will also be deleted.')) {
                    return;
                }

                // Get associated records for this wallet
                const walletRecords = AppState.records.filter(r => r.walletId === id);
                
                if (walletRecords.length > 0) {
                    const totalRecords = walletRecords.length;
                    const confirmRecords = confirm(
                        `This wallet has ${totalRecords} trading record${totalRecords > 1 ? 's' : ''}. ` +
                        'Deleting the wallet will also remove these records. Continue?'
                    );
                    
                    if (!confirmRecords) return;
                    
                    // Remove all associated records
                    AppState.records = AppState.records.filter(r => r.walletId !== id);
                }

                // Remove wallet
                AppState.wallets = AppState.wallets.filter(w => w.id !== id);
                
                // Also clean up any associated cashouts
                AppState.cashouts = AppState.cashouts.filter(c => c.walletId !== id);

                UI.update();
            }
        };

        // Cashout Management
        const CashoutManager = {
            showModal() {
                if (AppState.wallets.length === 0) {
                    alert('Please add a wallet first');
                    return;
                }
                
                const select = document.getElementById('cashout-wallet');
                select.innerHTML = '<option value="">Select Wallet</option>' +
                    AppState.wallets.map(wallet => 
                        `<option value="${wallet.id}">${wallet.name} ($${wallet.amount.toFixed(2)})</option>`
                    ).join('');
                
                document.getElementById('cashout-modal').style.display = 'block';
            },

            closeModal() {
                document.getElementById('cashout-modal').style.display = 'none';
                document.getElementById('cashout-wallet').value = '';
                document.getElementById('cashout-amount').value = '';
                document.getElementById('cashout-note').value = '';
            },

            processCashout() {
                const walletId = parseInt(document.getElementById('cashout-wallet').value);
                const amount = parseFloat(document.getElementById('cashout-amount').value);
                const note = document.getElementById('cashout-note').value;

                if (!walletId || isNaN(amount) || amount <= 0) {
                    alert('Please select a wallet and enter a valid amount');
                    return;
                }

                const wallet = AppState.wallets.find(w => w.id === walletId);
                
                if (amount > wallet.amount) {
                    alert('Insufficient funds in selected wallet');
                    return;
                }

                // Update wallet balance
                wallet.amount -= amount;

                // Add cashout record
                AppState.cashouts.push({
                    id: Date.now(),
                    walletId,
                    amount,
                    note,
                    date: new Date().toISOString().split('T')[0]
                });

                this.closeModal();
                UI.update();
            }
        };

        // Record Management
        const RecordManager = {
            add() {
                const walletId = parseInt(document.getElementById('record-wallet').value);
                const date = document.getElementById('record-date').value;
                const start = parseFloat(document.getElementById('record-start').value);
                const end = parseFloat(document.getElementById('record-end').value);
                const note = document.getElementById('record-note').value;

                if (!walletId || !date || isNaN(start) || isNaN(end)) {
                    alert('Please fill all required fields');
                    return;
                }

                const wallet = AppState.wallets.find(w => w.id === walletId);
                
                // Validate start amount doesn't exceed wallet balance
                if (start > wallet.amount) {
                    alert('Start amount cannot exceed wallet balance');
                    return;
                }

                const profit = end - start;
                
                // Update wallet balance based on the end amount
                wallet.amount = wallet.amount - start + end;

                // Add record
                AppState.records.push({
                    id: Date.now(),
                    walletId,
                    walletName: wallet.name,
                    date,
                    start,
                    end,
                    profit,
                    note
                });

                this.clearForm();
                UI.update();
            },

            delete(id) {
                const record = AppState.records.find(r => r.id === id);
                if (!record) return;

                const wallet = AppState.wallets.find(w => w.id === record.walletId);
                if (!wallet) {
                    alert('Associated wallet not found');
                    return;
                }

                if (confirm('Delete this record? This will revert the wallet balance.')) {
                    // Revert the wallet balance by reversing the original trade
                    // Remove end amount and add back start amount
                    wallet.amount = wallet.amount - record.end + record.start;
                    
                    // Remove the record
                    AppState.records = AppState.records.filter(r => r.id !== id);
                    
                    UI.update();
                    UI.save();
                }
            },

            clearForm() {
                document.getElementById('record-wallet').value = '';
                document.getElementById('record-date').value = '';
                document.getElementById('record-start').value = '';
                document.getElementById('record-end').value = '';
                document.getElementById('record-note').value = '';
                document.getElementById('profit-preview').textContent = '';
            },

            updateStartAmount() {
                const select = document.getElementById('record-wallet');
                const start = document.getElementById('record-start');
                
                if (select.value) {
                    const wallet = AppState.wallets.find(w => w.id === parseInt(select.value));
                    // Don't automatically set the start amount, just make input editable
                    start.removeAttribute('readonly');
                    start.placeholder = `Max: $${wallet.amount.toFixed(2)}`;
                    this.calculateProfit();
                } else {
                    start.value = '';
                    start.setAttribute('readonly', true);
                    start.placeholder = 'Start Amount';
                    document.getElementById('profit-preview').textContent = '';
                }
            },

            calculateProfit() {
                const start = parseFloat(document.getElementById('record-start').value) || 0;
                const end = parseFloat(document.getElementById('record-end').value) || 0;
                const profit = end - start;
                
                const preview = document.getElementById('profit-preview');
                if (start > 0 && end > 0) {
                    preview.textContent = `P/L: $${profit.toFixed(2)}`;
                    preview.className = profit >= 0 ? 'positive' : 'negative';
                } else {
                    preview.textContent = '';
                    preview.className = '';
                }
            },

            useFullAmount() {
                const select = document.getElementById('record-wallet');
                const start = document.getElementById('record-start');
                
                if (select.value) {
                    const wallet = AppState.wallets.find(w => w.id === parseInt(select.value));
                    start.value = wallet.amount.toFixed(2);
                    this.calculateProfit();
                }
            }
        };

        // Settings Management
        const SettingsManager = {
            updatePositionSize() {
                const value = parseFloat(document.getElementById('position-size').value);
                if (!isNaN(value) && value > 0) {
                    AppState.settings.positionSize = value;
                    UI.updateRiskAlerts();
                    UI.save();
                }
            },

            updateStopLoss() {
                const value = parseFloat(document.getElementById('stop-loss').value);
                if (!isNaN(value) && value > 0) {
                    AppState.settings.stopLoss = value;
                    UI.updateRiskAlerts();
                    UI.save();
                }
            }
        };

        // UI Management
        const UI = {
            update() {
                this.renderWallets();
                this.renderRecords();
                this.updateStats();
                this.updateLevelProgress(); // Add this line
                this.updateRiskAlerts();
                this.updateWalletSelects();
                this.save();
            },

            renderWallets() {
                const container = document.getElementById('wallets-container');
                if (AppState.wallets.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No wallets added yet</p>';
                    return;
                }
                
                container.innerHTML = AppState.wallets.map(wallet => `
                    <div class="wallet-item">
                        <div class="wallet-info">
                            <span class="wallet-name">${wallet.name}</span>
                            <span class="wallet-amount ${wallet.amount >= 0 ? 'positive' : 'negative'}">
                                $${wallet.amount.toFixed(2)}
                            </span>
                        </div>
                        <div class="wallet-actions">
                            <button onclick="WalletManager.delete(${wallet.id})" class="btn btn-danger btn-small">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            renderRecords() {
                const tbody = document.getElementById('records-tbody');
                if (AppState.records.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #64748b; padding: 20px;">No records yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = AppState.records.slice().reverse().map(record => `
                    <tr>
                        <td>${record.date}</td>
                        <td>$${record.start.toFixed(2)}</td>
                        <td>$${record.end.toFixed(2)}</td>
                        <td class="${record.profit >= 0 ? 'positive' : 'negative'}">
                            $${record.profit.toFixed(2)}
                        </td>
                        <td>${record.note || '-'}</td>
                        <td>
                            <button onclick="RecordManager.delete(${record.id})" class="btn btn-danger btn-small">
                                Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            },

            updateStats() {
                const stats = {
                    totalBankroll: AppState.wallets.reduce((sum, w) => sum + w.amount, 0),
                    totalProfit: AppState.records.reduce((sum, r) => sum + r.profit, 0),
                    totalCashout: AppState.cashouts.reduce((sum, c) => sum + c.amount, 0)
                };

                document.getElementById('stats-container').innerHTML = `
                    <div class="stat-item">
                        <span>Total Bankroll:</span>
                        <span class="${stats.totalBankroll >= 0 ? 'positive' : 'negative'}">
                            $${stats.totalBankroll.toFixed(2)}
                        </span>
                    </div>
                    <div class="stat-item">
                        <span>Total P/L:</span>
                        <span class="${stats.totalProfit >= 0 ? 'positive' : 'negative'}">
                            $${stats.totalProfit.toFixed(2)}
                        </span>
                    </div>
                    <div class="stat-item">
                        <span>Win Rate:</span>
                        <span>${this.calculateWinRate()}%</span>
                    </div>
                `;

                document.getElementById('total-cashout').textContent = `$${stats.totalCashout.toFixed(2)}`;
            },

            calculateWinRate() {
                if (AppState.records.length === 0) return '0.0';
                const wins = AppState.records.filter(r => r.profit > 0).length;
                return ((wins / AppState.records.length) * 100).toFixed(1);
            },

            updateRiskAlerts() {
                const totalBankroll = AppState.wallets.reduce((sum, w) => sum + w.amount, 0);
                const nextPosition = totalBankroll * (AppState.settings.positionSize / 100);
                const coolDown = totalBankroll * (AppState.settings.stopLoss / 100);

                document.getElementById('risk-alerts').innerHTML = `
                    <div class="risk-alert">
                        <div><strong>Next Position Size:</strong> $${nextPosition.toFixed(2)}</div>
                        <div><strong>Cool-Down Amount:</strong> $${coolDown.toFixed(2)}</div>
                    </div>
                `;
            },

            updateWalletSelects() {
                const recordSelect = document.getElementById('record-wallet');
                const options = AppState.wallets.length > 0 
                    ? AppState.wallets.map(wallet => 
                        `<option value="${wallet.id}">${wallet.name} ($${wallet.amount.toFixed(2)})</option>`
                    ).join('')
                    : '';
                
                recordSelect.innerHTML = '<option value="">Select Wallet</option>' + options;
            },

            save() {
                DataManager.saveToLocalStorage();
            },

            load() {
                try {
                    // Using a simple variable instead of localStorage for Claude artifacts
                    if (window.appData) {
                        Object.assign(AppState, JSON.parse(window.appData));
                    }
                } catch (error) {
                    console.warn('Could not load data');
                }
            },

            toggleTheme() {
                const body = document.body;
                const isDark = body.classList.toggle('dark-theme');
                
                // Save preference
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                
                // Update icon
                const btn = document.querySelector('.theme-btn');
                btn.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
            },

            loadTheme() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-theme');
                }
            },

            updateLevelProgress() {
                const difficulty = parseInt(document.getElementById('level-difficulty').value);
                const totalProfit = AppState.records.reduce((sum, r) => sum + r.profit, 0);
                
                const level = Math.floor(Math.abs(totalProfit) / difficulty);
                const progress = Math.abs(totalProfit) % difficulty;
                const progressPercent = (progress / difficulty) * 100;

                // Update level number and progress text
                document.getElementById('current-level').textContent = level;
                document.getElementById('level-progress-text').textContent = 
                    `$${progress.toFixed(2)}/$${difficulty}`;

                // Update progress bar
                const progressBar = document.getElementById('level-progress-bar');
                progressBar.style.width = `${progressPercent}%`;

                // Update color based on level ranges
                progressBar.className = 'progress-fill';
                if (level >= 40) {
                    progressBar.classList.add('legend');    // Purple/Pink gradient
                } else if (level >= 30) {
                    progressBar.classList.add('master');    // Red gradient
                } else if (level >= 20) {
                    progressBar.classList.add('expert');    // Gold gradient
                } else if (level >= 10) {
                    progressBar.classList.add('advanced');  // Green gradient
                } else {
                    progressBar.classList.add('novice');    // Blue/Purple gradient
                }
            },

            convertCurrency(from) {
                const rate = 0.65; // AUD to USD rate
                const audInput = document.getElementById('aud-amount');
                const usdInput = document.getElementById('usd-amount');

                if (from === 'aud') {
                    const aud = parseFloat(audInput.value) || 0;
                    usdInput.value = (aud * rate).toFixed(2);
                } else {
                    const usd = parseFloat(usdInput.value) || 0;
                    audInput.value = (usd / rate).toFixed(2);
                }
            },

            // Add to UI object
            isMobile: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent),

            initializeMobile() {
                if (this.isMobile) {
                    document.body.classList.add('mobile');
                    this.showSection('wallets');
                }
            },

            showSection(section) {
                // Hide all sections
                document.querySelectorAll('.left-panel > div, .right-panel').forEach(el => {
                    el.style.display = 'none';
                });

                // Show selected section
                switch(section) {
                    case 'wallets':
                        document.querySelector('.wallets-section').style.display = 'block';
                        break;
                    case 'records':
                        document.querySelector('.right-panel').style.display = 'block';
                        break;
                    case 'stats':
                        document.querySelector('.stats-section').style.display = 'block';
                        document.querySelector('.level-section').style.display = 'block';
                        break;
                    case 'settings':
                        document.querySelector('.risk-section').style.display = 'block';
                        document.querySelector('.converter-section').style.display = 'block';
                        break;
                }

                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`.nav-item[href="#${section}"]`).classList.add('active');
            },

            initialize() {
                // Load data from localStorage first
                DataManager.loadFromLocalStorage();
                
                this.loadTheme();
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('record-date').value = today;
                
                // Load settings into UI
                document.getElementById('position-size').value = AppState.settings.positionSize;
                document.getElementById('stop-loss').value = AppState.settings.stopLoss;
                
                // Set initial exchange rate
                document.getElementById('exchange-rate').textContent = '0.65';
                
                this.initializeMobile();
                
                UI.update();
            },

            showSection(section) {
                // Hide all sections
                document.querySelectorAll('.left-panel > div, .right-panel').forEach(el => {
                    el.style.display = 'none';
                });

                // Show selected section
                switch(section) {
                    case 'wallets':
                        document.querySelector('.wallets-section').style.display = 'block';
                        break;
                    case 'records':
                        document.querySelector('.right-panel').style.display = 'block';
                        break;
                    case 'stats':
                        document.querySelector('.stats-section').style.display = 'block';
                        document.querySelector('.level-section').style.display = 'block';
                        break;
                    case 'settings':
                        document.querySelector('.risk-section').style.display = 'block';
                        document.querySelector('.converter-section').style.display = 'block';
                        break;
                }

                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`.nav-item[href="#${section}"]`).classList.add('active');
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            UI.initialize();
        });

        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Handle Enter key in forms
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (document.getElementById('wallet-modal').style.display === 'block') {
                    WalletManager.addWallet();
                } else if (document.getElementById('cashout-modal').style.display === 'block') {
                    CashoutManager.processCashout();
                }
            }
        });
    </script>
</body>
</html>