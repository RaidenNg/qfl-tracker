<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QFL Strategy Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      background: #f0fcf9;
      max-width: 600px;
      margin: auto;
      color: #2d3436;
      position: relative;
    }
    h1 {
      font-size: 2rem;
      text-align: center;
      color: #00b894;
      margin-top: 2rem;
    }
    #description {
      font-size: 1rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    .lang-btn {
      position: fixed;
      right: 1rem;
      top: 1rem;
      background: #0984e3;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      z-index: 100;
    }
    label, input, select, button {
      display: block;
      width: 100%;
      margin-top: 1rem;
      font-size: 1.1rem;
    }
    input, select {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background: #00b894;
      color: white;
      border: none;
      padding: 0.7rem;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #019875;
    }
    .token-box {
      position: relative;
      border: 2px solid #00b894;
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
      background: #fff;
    }
    .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #d63031;
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1;
    }
    .level {
      background: #dff6f0;
      display: block;
      margin: 0.3rem 0;
      padding: 0.4rem 0.7rem;
      border-radius: 6px;
    }
    .token-header {
      padding-right: 20px;
    }
  </style>
</head>
<body>

<button class="lang-btn" onclick="toggleLang()">VI</button>

<h1 id="title">QFL Strategy Tracker</h1>
<div id="description">
  This tool helps track QFL buy zones. Enter a token, set your total investment, and get buy levels based on the base price. Use Kelly to auto-allocate funds.
</div>

<label id="manualLabel">Manual Token Input (ex: ARB)</label>
<input type="text" id="manualToken" placeholder="Enter token symbol" />

<label id="dropdownLabel">Select Binance Spot Pair</label>
<select id="dropdownToken">
  <option value="">-- Select a trading pair --</option>
</select>

<button onclick="addToken()" id="addTokenBtn">Add Token</button>

<label id="investLabel">Total Investment ($)</label>
<input type="number" id="totalInvest" placeholder="e.g. 1000" />

<label id="layersLabel">Buy Layers</label>
<select id="buyLayers">
  <option value="5">All (5 levels)</option>
  <option value="4">Stop at 20%</option>
  <option value="3">Stop at 15%</option>
  <option value="2">Stop at 10%</option>
  <option value="1">Stop at 5%</option>
</select>

<label><input type="checkbox" id="applyInvest" /> <span id="kellyLabel">Apply Kelly Allocation</span></label>

<button onclick="refreshPrices()" id="refreshBtn">Refresh Reports</button>

<div id="tokenList"></div>

<script>
  let tokens = [];
  let binancePairs = [];
  let currentLang = "en";

  const text = {
    en: {
      title: "QFL Strategy Tracker",
      description: "This tool helps track QFL buy zones. Enter a token, set your total investment, and get buy levels based on the base price. Use Kelly to auto-allocate funds.",
      manualLabel: "Manual Token Input (ex: ARB)",
      dropdownLabel: "Select Binance Spot Pair",
      addTokenBtn: "Add Token",
      investLabel: "Total Investment ($)",
      layersLabel: "Buy Layers",
      kellyLabel: "Apply Kelly Allocation",
      refreshBtn: "Refresh Reports",
      langBtn: "VI"
    },
    vi: {
      title: "Công Cụ QFL",
      description: "Công cụ theo dõi vùng mua theo QFL. Nhập token, tổng vốn đầu tư, và xem các mức mua từ giá cơ sở. Dùng Kelly để chia vốn tự động.",
      manualLabel: "Nhập thủ công (ví dụ: ARB)",
      dropdownLabel: "Chọn cặp Binance Spot",
      addTokenBtn: "Thêm Token",
      investLabel: "Tổng Vốn ($)",
      layersLabel: "Số lớp mua",
      kellyLabel: "Dùng Kelly chia vốn",
      refreshBtn: "Làm mới",
      langBtn: "EN"
    }
  };

  function toggleLang() {
    currentLang = currentLang === "en" ? "vi" : "en";
    const t = text[currentLang];
    document.getElementById("title").textContent = t.title;
    document.getElementById("description").textContent = t.description;
    document.getElementById("manualLabel").textContent = t.manualLabel;
    document.getElementById("dropdownLabel").textContent = t.dropdownLabel;
    document.getElementById("addTokenBtn").textContent = t.addTokenBtn;
    document.getElementById("investLabel").textContent = t.investLabel;
    document.getElementById("layersLabel").textContent = t.layersLabel;
    document.getElementById("kellyLabel").textContent = t.kellyLabel;
    document.getElementById("refreshBtn").textContent = t.refreshBtn;
    document.querySelector(".lang-btn").textContent = t.langBtn;
  }

  async function loadPairs() {
    const res = await fetch("https://api.binance.com/api/v3/exchangeInfo");
    const data = await res.json();
    binancePairs = data.symbols
      .filter(s => s.status === "TRADING" && s.quoteAsset === "USDT")
      .map(s => s.symbol)
      .sort();
    const dropdown = document.getElementById("dropdownToken");
    binancePairs.forEach(pair => {
      dropdown.innerHTML += `<option value="${pair}">${pair}</option>`;
    });
  }

  function formatPrice(p) {
    return p >= 0.1 ? p.toFixed(2) : parseFloat(p.toFixed(8)).toString();
  }

  function getKellyAllocations(layers) {
    const reversed = {
      1: [1],
      2: [0.4, 0.6],
      3: [0.2, 0.3, 0.5],
      4: [0.1, 0.2, 0.3, 0.4],
      5: [0.08, 0.12, 0.2, 0.25, 0.35]
    };
    return reversed[layers];
  }

  function generateBuyLevels(base, layers, totalInvest = 0, applyKelly = false) {
    const levels = [5, 10, 15, 20, 25].slice(0, layers);
    const kelly = getKellyAllocations(layers);
    return levels.map((pct, i) => {
      const price = base * (1 - pct / 100);
      const invest = applyKelly && totalInvest > 0 ? ` — Buy: $${(totalInvest * kelly[i]).toFixed(2)}` : '';
      return `${pct}% → $${formatPrice(price)}${invest}`;
    });
  }

  async function addToken() {
    const manual = document.getElementById("manualToken").value.trim().toUpperCase();
    const dropdown = document.getElementById("dropdownToken").value;
    const symbol = dropdown || (manual ? manual + "USDT" : "");

    if (!symbol || !binancePairs.includes(symbol)) {
      alert("Invalid token or not listed on Binance.");
      return;
    }

    if (tokens.find(t => t.symbol === symbol)) {
      alert("Token already added.");
      return;
    }

    const priceRes = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`);
    const { price } = await priceRes.json();
    const currentPrice = parseFloat(price);
    const base = currentPrice * 0.9;

    const totalInvest = parseFloat(document.getElementById("totalInvest").value) || 0;
    const layers = parseInt(document.getElementById("buyLayers").value);
    const applyKelly = document.getElementById("applyInvest").checked;

    const levels = generateBuyLevels(base, layers, totalInvest, applyKelly);
    const report = {
      symbol,
      price: currentPrice,
      base: base,
      levels
    };

    tokens.push(report);
    renderTokens();
  }

  function deleteToken(symbol) {
    tokens = tokens.filter(t => t.symbol !== symbol);
    renderTokens();
  }

  async function refreshPrices() {
    const totalInvest = parseFloat(document.getElementById("totalInvest").value) || 0;
    const layers = parseInt(document.getElementById("buyLayers").value);
    const applyKelly = document.getElementById("applyInvest").checked;

    for (let t of tokens) {
      const res = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${t.symbol}`);
      const data = await res.json();
      const newPrice = parseFloat(data.price);
      const newBase = newPrice * 0.9;
      const newLevels = generateBuyLevels(newBase, layers, totalInvest, applyKelly);
      t.price = newPrice;
      t.base = newBase;
      t.levels = newLevels;
    }
    renderTokens();
  }

  function renderTokens() {
    const container = document.getElementById("tokenList");
    container.innerHTML = "";
    tokens.forEach(t => {
      const box = document.createElement("div");
      box.className = "token-box";
      box.innerHTML = `
        <button class="delete-btn" onclick="deleteToken('${t.symbol}')">×</button>
        <div class="token-header">
          <strong>${t.symbol}</strong><br/>
          Current Price: $${formatPrice(t.price)}<br/>
          Base Price (90%): $${formatPrice(t.base)}
        </div>
        <div class="levels">
          ${t.levels.map(l => `<div class="level">${l}</div>`).join("")}
        </div>
      `;
      container.appendChild(box);
    });
  }

  loadPairs();
</script>

</body>
</html>